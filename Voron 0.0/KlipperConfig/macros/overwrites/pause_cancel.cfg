##############################################################################
# Pause print
##############################################################################
[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  _TOOLHEAD_PARK_PAUSE_CANCEL

##############################################################################
# Cancel print
##############################################################################
[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
  ## Move head and retract only if not already in the pause state and park set to true
  {% if printer.pause_resume.is_paused|lower == 'false' and park|lower == 'true'%}
    _TOOLHEAD_PARK_PAUSE_CANCEL
  {% endif %}
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

##############################################################################
# Base macro for pause and cancel print
##############################################################################
[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
gcode:
  {% set max = {'x' : printer.configfile.config["stepper_x"]["position_max"]|float,'y' : printer.configfile.config["stepper_y"]["position_max"]|float,'z' : printer.configfile.config["stepper_z"]["position_max"]|float} %}
  {% set center = {'x': max.x / 2} %}
  {% set extrude = printer['gcode_macro _USER_VARIABLE'].pause_retract %}

  {% if printer.toolhead.position.z < (max.z - 20) %}
    {% set z_safe = 20.0 %}
  {% else %}
    {% set z_safe = max.z - printer.toolhead.position.z %}
  {% endif %}

  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G1 E-{extrude} F2100
    {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}

  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
    {% if printer.gcode_move.absolute_coordinates|lower == 'false' %} G91 {% endif %}

    SET_FAN_SPEED FAN=nevermore SPEED=0
    SET_TEMPERATURE_FAN_TARGET temperature_fan=enclosure_fan TARGET=0
    M117 Pause...
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}
