##############################################################################
# Filament change
##############################################################################
[gcode_macro M600]
gcode:
    ### Get max move positions 
    {% set max = {'x' : printer.configfile.config["stepper_x"]["position_max"]|float,'y' : printer.configfile.config["stepper_y"]["position_max"]|float,'z' : printer.configfile.config["stepper_z"]["position_max"]|float} %}
    {% set center = {'x': max.x / 2} %}

    ### Check secure movement position for Z
    {% if printer.toolhead.position.z < (max.z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max.z - printer.toolhead.position.z %}
    {% endif %}

    ### Go to secure position
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{z_safe}
    G90
    G1 X{center.x} Y0 F10000
    G91
    G1 E-2 F1200
    M117 Change Filament
    G1 E-80 F2400
    RESTORE_GCODE_STATE NAME=M600_state